<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - CPLS Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
        }
        .sidebar a {
            color: #ecf0f1;
            text-decoration: none;
            padding: 15px;
            display: block;
            transition: all 0.3s;
        }
        .sidebar a:hover {
            background: #34495e;
            padding-left: 25px;
        }
        .sidebar a.active {
            background: #3498db;
        }
        .sidebar-section {
            color: #95a5a6;
            font-size: 0.8rem;
            padding: 10px 15px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card {
            border-left: 4px solid #3498db;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .badge-free { background: #95a5a6; }
        .badge-basic { background: #3498db; }
        .badge-premium { background: #9b59b6; }
        .badge-enterprise { background: #f39c12; }
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        .search-box {
            max-width: 300px;
        }
        .modal-lg {
            max-width: 700px;
        }
        .copy-btn {
            cursor: pointer;
        }
        .copy-btn:hover {
            color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar px-0">
                <div class="text-center py-4">
                    <h4 class="text-white">CPLS Admin</h4>
                    <p class="text-muted small">Stock Trading System</p>
                </div>
                <nav>
                    <a href="/admin">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>

                    <div class="sidebar-section">User Management</div>
                    <a href="/admin/users" class="active">
                        <i class="bi bi-people"></i> Users
                    </a>

                    <div class="sidebar-section">System</div>
                    <a href="/api/v1/health/db" target="_blank">
                        <i class="bi bi-database"></i> DB Health
                    </a>
                    <a href="/health" target="_blank">
                        <i class="bi bi-heart-pulse"></i> Health Check
                    </a>
                    <hr class="text-white">
                    <a href="/admin/logout" class="text-danger">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10">
                <nav class="navbar navbar-light bg-light mb-4">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1"><i class="bi bi-people"></i> User Management</span>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-info me-3">Supabase Mode</span>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle"></i> {{ .AdminUser }}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item text-danger" href="/admin/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>

                <div class="container-fluid">
                    {{ if .Error }}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> {{ .Error }}
                    </div>
                    {{ end }}

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Users</h6>
                                    <h2 class="card-title" id="stat-total">{{ if .Stats }}{{ .Stats.total }}{{ else }}0{{ end }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-people"></i> Registered</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card" style="border-left-color: #27ae60;">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Active Users</h6>
                                    <h2 class="card-title text-success" id="stat-active">{{ if .Stats }}{{ .Stats.active }}{{ else }}0{{ end }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-check-circle"></i> Active</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card" style="border-left-color: #e74c3c;">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Banned Users</h6>
                                    <h2 class="card-title text-danger" id="stat-banned">{{ if .Stats }}{{ .Stats.banned }}{{ else }}0{{ end }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-slash-circle"></i> Banned</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card" style="border-left-color: #9b59b6;">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">This Page</h6>
                                    <h2 class="card-title">{{ .Total }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-list"></i> Results</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <form method="GET" action="/admin/users" class="d-flex">
                                        <input type="text" name="search" class="form-control search-box me-2"
                                               placeholder="Search users..." value="{{ .Search }}">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-8 text-end">
                                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createUserModal">
                                        <i class="bi bi-plus-circle"></i> Create User
                                    </button>
                                    <button class="btn btn-info me-2" onclick="syncAllUsers()">
                                        <i class="bi bi-arrow-repeat"></i> Sync All
                                    </button>
                                    <a href="/admin/api/users/export" class="btn btn-secondary">
                                        <i class="bi bi-download"></i> Export
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-table"></i> Users List</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Plan</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{ range .Users }}
                                        <tr data-user-id="{{ .ID }}">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar me-2">
                                                        {{ if .Nickname }}{{ slice .Nickname 0 1 }}{{ else if .FullName }}{{ slice .FullName 0 1 }}{{ else }}U{{ end }}
                                                    </div>
                                                    <div>
                                                        <strong>{{ if .FullName }}{{ .FullName }}{{ else }}N/A{{ end }}</strong>
                                                        {{ if .Nickname }}<br><small class="text-muted">@{{ .Nickname }}</small>{{ end }}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <a href="mailto:{{ .Email }}">{{ .Email }}</a>
                                            </td>
                                            <td>{{ if .PhoneNumber }}{{ .PhoneNumber }}{{ else }}<span class="text-muted">-</span>{{ end }}</td>
                                            <td>
                                                {{ if eq .SubscriptionPlan "enterprise" }}
                                                <span class="badge badge-enterprise">Enterprise</span>
                                                {{ else if eq .SubscriptionPlan "premium" }}
                                                <span class="badge badge-premium">Premium</span>
                                                {{ else if eq .SubscriptionPlan "basic" }}
                                                <span class="badge badge-basic">Basic</span>
                                                {{ else }}
                                                <span class="badge badge-free">Free</span>
                                                {{ end }}
                                            </td>
                                            <td>
                                                {{ if .IsBanned }}
                                                <span class="badge bg-danger">Banned</span>
                                                {{ else if .IsActive }}
                                                <span class="badge bg-success">Active</span>
                                                {{ else }}
                                                <span class="badge bg-secondary">Inactive</span>
                                                {{ end }}
                                            </td>
                                            <td>
                                                <small>{{ .CreatedAt.Format "2006-01-02" }}</small>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-primary action-btn"
                                                            onclick="viewUser('{{ .ID }}')" title="View">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning action-btn"
                                                            onclick="editUser('{{ .ID }}')" title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info action-btn"
                                                            onclick="editSubscription('{{ .ID }}', '{{ .SubscriptionPlan }}')" title="Subscription">
                                                        <i class="bi bi-credit-card"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary action-btn"
                                                            onclick="resetPassword('{{ .ID }}', '{{ .Email }}')" title="Reset Password">
                                                        <i class="bi bi-key"></i>
                                                    </button>
                                                    {{ if .IsBanned }}
                                                    <button class="btn btn-sm btn-outline-success action-btn"
                                                            onclick="unbanUser('{{ .ID }}')" title="Unban">
                                                        <i class="bi bi-unlock"></i>
                                                    </button>
                                                    {{ else }}
                                                    <button class="btn btn-sm btn-outline-danger action-btn"
                                                            onclick="banUser('{{ .ID }}')" title="Ban">
                                                        <i class="bi bi-slash-circle"></i>
                                                    </button>
                                                    {{ end }}
                                                    <button class="btn btn-sm btn-outline-danger action-btn"
                                                            onclick="deleteUser('{{ .ID }}', '{{ .Email }}')" title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {{ else }}
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                                <p class="mt-2">No users found</p>
                                            </td>
                                        </tr>
                                        {{ end }}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pagination -->
                        {{ if gt .TotalPages 1 }}
                        <div class="card-footer">
                            <nav aria-label="User pagination">
                                <ul class="pagination justify-content-center mb-0">
                                    {{ if gt .Page 1 }}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ subtract .Page 1 }}&search={{ .Search }}">Previous</a>
                                    </li>
                                    {{ end }}

                                    {{ range $i := iterate .TotalPages }}
                                    <li class="page-item {{ if eq (add $i 1) $.Page }}active{{ end }}">
                                        <a class="page-link" href="?page={{ add $i 1 }}&search={{ $.Search }}">{{ add $i 1 }}</a>
                                    </li>
                                    {{ end }}

                                    {{ if lt .Page .TotalPages }}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ add .Page 1 }}&search={{ .Search }}">Next</a>
                                    </li>
                                    {{ end }}
                                </ul>
                            </nav>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Create New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="password" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="full_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nickname</label>
                            <input type="text" class="form-control" name="nickname">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="text" class="form-control" name="phone_number">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subscription Plan</label>
                            <select class="form-select" name="subscription_plan">
                                <option value="free">Free</option>
                                <option value="basic">Basic</option>
                                <option value="premium">Premium</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createUser()">Create User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View User Modal -->
    <div class="modal fade" id="viewUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person"></i> User Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewUserContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info" id="syncUserBtn">
                        <i class="bi bi-arrow-repeat"></i> Sync with Auth
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" name="user_id" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="editEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="full_name" id="editFullName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nickname</label>
                            <input type="text" class="form-control" name="nickname" id="editNickname">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="text" class="form-control" name="phone_number" id="editPhoneNumber">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveUser()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div class="modal fade" id="subscriptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-credit-card"></i> Edit Subscription</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="subscriptionForm">
                        <input type="hidden" name="user_id" id="subUserId">
                        <div class="mb-3">
                            <label class="form-label">Subscription Plan</label>
                            <select class="form-select" name="plan" id="subPlan">
                                <option value="free">Free</option>
                                <option value="basic">Basic</option>
                                <option value="premium">Premium</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Date (Optional)</label>
                            <input type="date" class="form-control" name="end_date" id="subEndDate">
                            <small class="text-muted">Leave empty for unlimited</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="saveSubscription()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="bi bi-key"></i> Reset Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="resetPasswordForm">
                        <input type="hidden" name="user_id" id="resetUserId">
                        <p><strong>Email:</strong> <span id="resetUserEmail"></span></p>

                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" name="new_password" id="newPassword" minlength="6">
                            <small class="text-muted">Enter new password directly, or generate a reset link below</small>
                        </div>

                        <div class="alert alert-info" id="resetLinkResult" style="display: none;">
                            <strong>Reset Link:</strong>
                            <div class="input-group mt-2">
                                <input type="text" class="form-control" id="resetLinkValue" readonly>
                                <button class="btn btn-outline-secondary copy-btn" type="button" onclick="copyResetLink()">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" onclick="generateResetLink()">
                        <i class="bi bi-link"></i> Generate Link
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveNewPassword()">
                        <i class="bi bi-check"></i> Set Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div class="modal fade" id="banUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-slash-circle"></i> Ban User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="banUserForm">
                        <input type="hidden" name="user_id" id="banUserId">
                        <div class="mb-3">
                            <label class="form-label">Reason for ban</label>
                            <textarea class="form-control" name="reason" id="banReason" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmBan()">Ban User</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentUserId = null;

        // Create User
        function createUser() {
            const form = document.getElementById('createUserForm');
            const data = {
                email: form.email.value,
                password: form.password.value,
                full_name: form.full_name.value,
                nickname: form.nickname.value,
                phone_number: form.phone_number.value,
                subscription_plan: form.subscription_plan.value
            };

            $.ajax({
                url: '/admin/api/users',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    alert('User created successfully!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        // View User
        function viewUser(userId) {
            currentUserId = userId;
            const modal = new bootstrap.Modal(document.getElementById('viewUserModal'));
            modal.show();

            document.getElementById('viewUserContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading...</p>
                </div>
            `;

            $.get('/admin/api/users/' + userId, function(data) {
                const p = data.profile;
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Profile Information</h6>
                            <table class="table table-sm">
                                <tr><th>ID</th><td><small>${p.id}</small></td></tr>
                                <tr><th>Email</th><td>${p.email || '-'}</td></tr>
                                <tr><th>Full Name</th><td>${p.full_name || '-'}</td></tr>
                                <tr><th>Nickname</th><td>${p.nickname || '-'}</td></tr>
                                <tr><th>Phone</th><td>${p.phone_number || '-'}</td></tr>
                                <tr><th>Plan</th><td><span class="badge badge-${p.subscription_plan || 'free'}">${p.subscription_plan || 'free'}</span></td></tr>
                                <tr><th>Status</th><td>${p.is_banned ? '<span class="badge bg-danger">Banned</span>' : (p.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>')}</td></tr>
                                ${p.ban_reason ? '<tr><th>Ban Reason</th><td class="text-danger">' + p.ban_reason + '</td></tr>' : ''}
                                <tr><th>Created</th><td>${new Date(p.created_at).toLocaleString()}</td></tr>
                                <tr><th>Updated</th><td>${new Date(p.updated_at).toLocaleString()}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Auth Information</h6>
                `;

                if (data.auth_user) {
                    const a = data.auth_user;
                    html += `
                        <table class="table table-sm">
                            <tr><th>Auth Email</th><td>${a.email || '-'}</td></tr>
                            <tr><th>Email Confirmed</th><td>${a.email_confirmed_at ? '<span class="text-success">Yes</span>' : '<span class="text-danger">No</span>'}</td></tr>
                            <tr><th>Phone</th><td>${a.phone || '-'}</td></tr>
                            <tr><th>Last Sign In</th><td>${a.last_sign_in_at ? new Date(a.last_sign_in_at).toLocaleString() : '-'}</td></tr>
                            <tr><th>Auth Created</th><td>${new Date(a.created_at).toLocaleString()}</td></tr>
                        </table>
                    `;
                } else {
                    html += `<div class="alert alert-warning">Auth user not found or error: ${data.auth_err || 'Unknown'}</div>`;
                }

                html += '</div></div>';
                document.getElementById('viewUserContent').innerHTML = html;
            }).fail(function(xhr) {
                document.getElementById('viewUserContent').innerHTML = `
                    <div class="alert alert-danger">Error loading user: ${xhr.responseJSON?.error || 'Unknown error'}</div>
                `;
            });

            document.getElementById('syncUserBtn').onclick = function() {
                syncUser(userId);
            };
        }

        // Edit User
        function editUser(userId) {
            $.get('/admin/api/users/' + userId, function(data) {
                const p = data.profile;
                document.getElementById('editUserId').value = userId;
                document.getElementById('editEmail').value = p.email || '';
                document.getElementById('editFullName').value = p.full_name || '';
                document.getElementById('editNickname').value = p.nickname || '';
                document.getElementById('editPhoneNumber').value = p.phone_number || '';

                new bootstrap.Modal(document.getElementById('editUserModal')).show();
            });
        }

        function saveUser() {
            const userId = document.getElementById('editUserId').value;
            const data = {
                email: document.getElementById('editEmail').value,
                full_name: document.getElementById('editFullName').value,
                nickname: document.getElementById('editNickname').value,
                phone_number: document.getElementById('editPhoneNumber').value
            };

            $.ajax({
                url: '/admin/api/users/' + userId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function() {
                    alert('User updated successfully!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        // Subscription
        function editSubscription(userId, currentPlan) {
            document.getElementById('subUserId').value = userId;
            document.getElementById('subPlan').value = currentPlan || 'free';
            document.getElementById('subEndDate').value = '';
            new bootstrap.Modal(document.getElementById('subscriptionModal')).show();
        }

        function saveSubscription() {
            const userId = document.getElementById('subUserId').value;
            const data = {
                plan: document.getElementById('subPlan').value,
                end_date: document.getElementById('subEndDate').value
            };

            $.ajax({
                url: '/admin/api/users/' + userId + '/subscription',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function() {
                    alert('Subscription updated!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        // Reset Password
        function resetPassword(userId, email) {
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetUserEmail').textContent = email;
            document.getElementById('newPassword').value = '';
            document.getElementById('resetLinkResult').style.display = 'none';
            new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
        }

        function saveNewPassword() {
            const userId = document.getElementById('resetUserId').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!newPassword || newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            $.ajax({
                url: '/admin/api/users/' + userId + '/reset-password',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ new_password: newPassword }),
                success: function() {
                    alert('Password updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function generateResetLink() {
            const userId = document.getElementById('resetUserId').value;

            $.ajax({
                url: '/admin/api/users/' + userId + '/reset-password',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ send_link: true }),
                success: function(response) {
                    document.getElementById('resetLinkValue').value = response.reset_link;
                    document.getElementById('resetLinkResult').style.display = 'block';
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function copyResetLink() {
            const link = document.getElementById('resetLinkValue');
            link.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        }

        // Ban/Unban
        function banUser(userId) {
            document.getElementById('banUserId').value = userId;
            document.getElementById('banReason').value = '';
            new bootstrap.Modal(document.getElementById('banUserModal')).show();
        }

        function confirmBan() {
            const userId = document.getElementById('banUserId').value;
            const reason = document.getElementById('banReason').value;

            $.ajax({
                url: '/admin/api/users/' + userId + '/ban',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ reason: reason }),
                success: function() {
                    alert('User banned!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function unbanUser(userId) {
            if (!confirm('Unban this user?')) return;

            $.ajax({
                url: '/admin/api/users/' + userId + '/unban',
                method: 'POST',
                success: function() {
                    alert('User unbanned!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        // Delete User
        function deleteUser(userId, email) {
            if (!confirm('Are you sure you want to delete user: ' + email + '?\n\nThis action cannot be undone!')) return;

            $.ajax({
                url: '/admin/api/users/' + userId,
                method: 'DELETE',
                success: function() {
                    alert('User deleted!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        // Sync
        function syncUser(userId) {
            $.ajax({
                url: '/admin/api/users/' + userId + '/sync',
                method: 'POST',
                success: function() {
                    alert('User synced successfully!');
                    viewUser(userId); // Refresh view
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function syncAllUsers() {
            if (!confirm('Sync all users with Supabase Auth? This may take a while.')) return;

            $.ajax({
                url: '/admin/api/users/sync-all',
                method: 'POST',
                success: function(response) {
                    alert('Sync completed!\nSynced: ' + response.synced + '\nFailed: ' + response.failed);
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }
    </script>
</body>
</html>
