<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Management - CPLS Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
        }
        .sidebar a {
            color: #ecf0f1;
            text-decoration: none;
            padding: 15px;
            display: block;
            transition: all 0.3s;
        }
        .sidebar a:hover {
            background: #34495e;
            padding-left: 25px;
        }
        .sidebar a.active {
            background: #3498db;
        }
        .sidebar-section {
            color: #95a5a6;
            font-size: 0.8rem;
            padding: 10px 15px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card {
            border-left: 4px solid #3498db;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .badge-hose { background: #e74c3c; }
        .badge-hnx { background: #3498db; }
        .badge-upcom { background: #27ae60; }
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        .stock-code {
            font-weight: bold;
            color: #2c3e50;
            font-family: monospace;
            font-size: 1.1em;
        }
        .search-box {
            max-width: 300px;
        }
        .sync-info {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .floor-filter .btn {
            min-width: 80px;
        }
        .floor-filter .btn.active {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar px-0">
                <div class="text-center py-4">
                    <h4 class="text-white">CPLS Admin</h4>
                    <p class="text-muted small">Stock Trading System</p>
                </div>
                <nav>
                    <a href="/admin">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>

                    <div class="sidebar-section">User Management</div>
                    <a href="/admin/users">
                        <i class="bi bi-people"></i> Users
                    </a>

                    <div class="sidebar-section">Stock Data</div>
                    <a href="/admin/stocks" class="active">
                        <i class="bi bi-graph-up"></i> Stocks
                    </a>

                    <div class="sidebar-section">System</div>
                    <a href="/api/v1/health/db" target="_blank">
                        <i class="bi bi-database"></i> DB Health
                    </a>
                    <a href="/health" target="_blank">
                        <i class="bi bi-heart-pulse"></i> Health Check
                    </a>
                    <hr class="text-white">
                    <a href="/admin/logout" class="text-danger">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10">
                <nav class="navbar navbar-light bg-light mb-4">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1"><i class="bi bi-graph-up"></i> Stock Management</span>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-info me-3">Supabase Mode</span>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle"></i> {{ .AdminUser }}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item text-danger" href="/admin/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>

                <div class="container-fluid">
                    {{ if .Error }}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> {{ .Error }}
                    </div>
                    {{ end }}

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Stocks</h6>
                                    <h2 class="card-title" id="stat-total">{{ if .Stats }}{{ .Stats.total }}{{ else }}0{{ end }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-collection"></i> Listed</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card" style="border-left-color: #e74c3c;">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">HOSE</h6>
                                    <h2 class="card-title text-danger">{{ if .Stats }}{{ index .Stats.by_floor "HOSE" }}{{ else }}0{{ end }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-building"></i> Ho Chi Minh</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card" style="border-left-color: #3498db;">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">HNX</h6>
                                    <h2 class="card-title text-primary">{{ if .Stats }}{{ index .Stats.by_floor "HNX" }}{{ else }}0{{ end }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-building"></i> Ha Noi</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card" style="border-left-color: #27ae60;">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">UPCOM</h6>
                                    <h2 class="card-title text-success">{{ if .Stats }}{{ index .Stats.by_floor "UPCOM" }}{{ else }}0{{ end }}</h2>
                                    <p class="card-text text-muted"><i class="bi bi-building"></i> Unlisted</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <form method="GET" action="/admin/stocks" class="d-flex" id="searchForm">
                                        <input type="text" name="search" class="form-control search-box me-2"
                                               placeholder="Search by code or name..." value="{{ .Search }}" id="searchInput">
                                        <input type="hidden" name="floor" value="{{ .Floor }}" id="floorInput">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-4">
                                    <div class="btn-group floor-filter" role="group">
                                        <button type="button" class="btn btn-outline-secondary {{ if eq .Floor "all" }}active{{ end }}" onclick="filterByFloor('all')">All</button>
                                        <button type="button" class="btn btn-outline-danger {{ if eq .Floor "HOSE" }}active{{ end }}" onclick="filterByFloor('HOSE')">HOSE</button>
                                        <button type="button" class="btn btn-outline-primary {{ if eq .Floor "HNX" }}active{{ end }}" onclick="filterByFloor('HNX')">HNX</button>
                                        <button type="button" class="btn btn-outline-success {{ if eq .Floor "UPCOM" }}active{{ end }}" onclick="filterByFloor('UPCOM')">UPCOM</button>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-success me-2" onclick="syncStocks()" id="syncBtn">
                                        <i class="bi bi-arrow-repeat"></i> Sync VNDirect
                                    </button>
                                    <button class="btn btn-info me-2" onclick="showImportModal()">
                                        <i class="bi bi-upload"></i> Import JSON
                                    </button>
                                    <a href="/admin/api/stocks/export?floor={{ .Floor }}" class="btn btn-secondary">
                                        <i class="bi bi-download"></i> Export
                                    </a>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <span class="sync-info">
                                        <i class="bi bi-clock"></i> Last sync:
                                        {{ if .LastSync }}
                                            <span id="lastSyncTime">{{ .LastSync.Format "2006-01-02 15:04:05" }}</span>
                                        {{ else }}
                                            <span id="lastSyncTime" class="text-warning">Never synced</span>
                                        {{ end }}
                                    </span>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showSchedulerModal()">
                                        <i class="bi bi-calendar-check"></i>
                                        <span id="schedulerStatusBadge">Auto Sync: <span id="schedulerStatus">Loading...</span></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Sync Card -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Price Data Sync</h6>
                            <button class="btn btn-sm btn-outline-dark" onclick="showPriceConfigModal()">
                                <i class="bi bi-gear"></i> Settings
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="priceFilesCount">-</h4>
                                        <small class="text-muted">Price Files</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <span id="priceLastSync" class="text-muted">-</span>
                                        <br><small class="text-muted">Last Full Sync</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div id="priceSyncStatus">
                                        <span class="badge bg-secondary">Idle</span>
                                    </div>
                                </div>
                                <div class="col-md-3 text-end">
                                    <button class="btn btn-warning me-1" onclick="startPriceSync()" id="startPriceSyncBtn">
                                        <i class="bi bi-play-fill"></i> Start Sync
                                    </button>
                                    <button class="btn btn-danger" onclick="stopPriceSync()" id="stopPriceSyncBtn" style="display: none;">
                                        <i class="bi bi-stop-fill"></i> Stop
                                    </button>
                                </div>
                            </div>
                            <!-- Progress Bar (hidden by default) -->
                            <div id="priceSyncProgress" style="display: none;" class="mt-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span id="progressText">Processing...</span>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                                         id="progressBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="row mt-2 small text-muted">
                                    <div class="col-4">Current: <span id="currentStock">-</span></div>
                                    <div class="col-4">Success: <span id="successCount" class="text-success">0</span> | Failed: <span id="failedCount" class="text-danger">0</span></div>
                                    <div class="col-4">ETA: <span id="etaTime">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Indicators Card -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-calculator"></i> Technical Indicators</h6>
                            <button class="btn btn-sm btn-outline-light" onclick="showTopRSModal()">
                                <i class="bi bi-trophy"></i> Top RS Stocks
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 id="indicatorCount">-</h4>
                                        <small class="text-muted">Stocks with Indicators</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <span id="indicatorLastUpdate" class="text-muted">-</span>
                                        <br><small class="text-muted">Last Calculation</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-muted small">
                                        <div><i class="bi bi-check-circle text-success"></i> RS Ranking (3D, 1M, 3M, 1Y)</div>
                                        <div><i class="bi bi-check-circle text-success"></i> MACD, RSI, MA (10,30,50,200)</div>
                                        <div><i class="bi bi-check-circle text-success"></i> Volume Analysis</div>
                                    </div>
                                </div>
                                <div class="col-md-3 text-end">
                                    <button class="btn btn-info" onclick="calculateIndicators()" id="calcIndicatorsBtn">
                                        <i class="bi bi-calculator"></i> Calculate All
                                    </button>
                                </div>
                            </div>
                            <div id="indicatorProgress" style="display: none;" class="mt-3">
                                <div class="d-flex justify-content-center">
                                    <div class="spinner-border text-info me-2" role="status"></div>
                                    <span>Calculating indicators for all stocks...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Indicators Filter Widget -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-funnel"></i> Technical Indicators Filter</h5>
                            <button class="btn btn-primary btn-sm" onclick="applyFilter()">
                                <i class="bi bi-search"></i> Apply Filter
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- RS Filters -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">RS Avg Min</label>
                                    <input type="number" class="form-control form-control-sm" id="rs_avg_min" value="40" step="1" min="0" max="100">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">RS 3D Min</label>
                                    <input type="number" class="form-control form-control-sm" id="rs_3d_min" value="0" step="1" min="0" max="100">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">RS 1M Min</label>
                                    <input type="number" class="form-control form-control-sm" id="rs_1m_min" value="0" step="1" min="0" max="100">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">RS 3M Min</label>
                                    <input type="number" class="form-control form-control-sm" id="rs_3m_min" value="0" step="1" min="0" max="100">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">RS 1Y Min</label>
                                    <input type="number" class="form-control form-control-sm" id="rs_1y_min" value="80" step="1" min="0" max="100">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">MACD His Min</label>
                                    <input type="number" class="form-control form-control-sm" id="macd_hist_min" value="-0.1" step="0.01">
                                </div>

                                <!-- Price Filters -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Price Min</label>
                                    <input type="number" class="form-control form-control-sm" id="price_min" value="0" step="1" min="0" placeholder="1000 VND">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Price Max</label>
                                    <input type="number" class="form-control form-control-sm" id="price_max" value="0" step="1" min="0" placeholder="1000 VND">
                                </div>

                                <!-- Volume/Value Filters -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Avg Vol Min</label>
                                    <input type="number" class="form-control form-control-sm" id="avg_vol_min" value="600000" step="10000">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Avg Trading Val (tỷ)</label>
                                    <input type="number" class="form-control form-control-sm" id="avg_trading_val_min" value="0" step="0.1" placeholder="tỷ VND">
                                </div>

                                <!-- MA Conditions -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">MA Conditions</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ma10_above_ma30">
                                        <label class="form-check-label" for="ma10_above_ma30">MA10 >= MA30</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">&nbsp;</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ma50_above_ma200">
                                        <label class="form-check-label" for="ma50_above_ma200">MA50 >= MA200</label>
                                    </div>
                                </div>

                                <!-- Sort & Limit -->
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Sort By</label>
                                    <select class="form-select form-select-sm" id="sort_by">
                                        <option value="rs_avg">RS Avg</option>
                                        <option value="rs_1y">RS 1Y</option>
                                        <option value="rs_3m">RS 3M</option>
                                        <option value="rs_1m">RS 1M</option>
                                        <option value="rs_3d">RS 3D</option>
                                        <option value="macd_hist">MACD Hist</option>
                                        <option value="price">Price</option>
                                        <option value="avg_vol">Avg Volume</option>
                                        <option value="avg_trading_val">Avg Trading Val</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Limit</label>
                                    <input type="number" class="form-control form-control-sm" id="limit" value="50" min="1" max="200">
                                </div>
                            </div>

                            <!-- Results -->
                            <div class="mt-4">
                                <div id="filter-loading" class="text-center d-none">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div id="filter-result" class="d-none">
                                    <h6><i class="bi bi-list-ul"></i> Results: <span id="result-count" class="badge bg-primary">0</span> stocks</h6>
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-sm table-hover table-striped">
                                            <thead class="table-dark sticky-top">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Code</th>
                                                    <th>Price</th>
                                                    <th>RS Avg</th>
                                                    <th>RS 3D</th>
                                                    <th>RS 1M</th>
                                                    <th>RS 3M</th>
                                                    <th>RS 1Y</th>
                                                    <th>MACD His</th>
                                                    <th>Avg Vol</th>
                                                    <th>Avg Trading Vol</th>
                                                    <th>MA10>=MA30</th>
                                                    <th>MA50>=MA200</th>
                                                </tr>
                                            </thead>
                                            <tbody id="result-table"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stocks Table -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-table"></i> Stock List ({{ .Total }} results)</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Code</th>
                                            <th>Company Name</th>
                                            <th>Short Name</th>
                                            <th>Floor</th>
                                            <th>Status</th>
                                            <th>Listed Date</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{ range .Stocks }}
                                        <tr>
                                            <td>
                                                <span class="stock-code">{{ .Code }}</span>
                                            </td>
                                            <td>
                                                <div>{{ .CompanyName }}</div>
                                                <small class="text-muted">{{ .CompanyNameEng }}</small>
                                            </td>
                                            <td>{{ .ShortName }}</td>
                                            <td>
                                                {{ if eq .Floor "HOSE" }}
                                                <span class="badge badge-hose">HOSE</span>
                                                {{ else if eq .Floor "HNX" }}
                                                <span class="badge badge-hnx">HNX</span>
                                                {{ else }}
                                                <span class="badge badge-upcom">UPCOM</span>
                                                {{ end }}
                                            </td>
                                            <td>
                                                {{ if .IsActive }}
                                                <span class="badge bg-success">Active</span>
                                                {{ else }}
                                                <span class="badge bg-secondary">Inactive</span>
                                                {{ end }}
                                            </td>
                                            <td>
                                                <small>{{ .ListedDate }}</small>
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewStock('{{ .Code }}')" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStock('{{ .Code }}')" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {{ else }}
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                                <p class="mt-2">No stocks found. Click "Sync from VNDirect" to fetch stock data.</p>
                                            </td>
                                        </tr>
                                        {{ end }}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pagination -->
                        {{ if gt .TotalPages 1 }}
                        <div class="card-footer">
                            <nav aria-label="Stock pagination">
                                <ul class="pagination justify-content-center mb-0">
                                    {{ if gt .Page 1 }}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ subtract .Page 1 }}&search={{ .Search }}&floor={{ .Floor }}">Previous</a>
                                    </li>
                                    {{ end }}

                                    {{ range $i := iterate .TotalPages }}
                                    {{ if lt $i 10 }}
                                    <li class="page-item {{ if eq (add $i 1) $.Page }}active{{ end }}">
                                        <a class="page-link" href="?page={{ add $i 1 }}&search={{ $.Search }}&floor={{ $.Floor }}">{{ add $i 1 }}</a>
                                    </li>
                                    {{ end }}
                                    {{ end }}

                                    {{ if gt .TotalPages 10 }}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ .TotalPages }}&search={{ .Search }}&floor={{ .Floor }}">{{ .TotalPages }}</a>
                                    </li>
                                    {{ end }}

                                    {{ if lt .Page .TotalPages }}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ add .Page 1 }}&search={{ .Search }}&floor={{ .Floor }}">Next</a>
                                    </li>
                                    {{ end }}
                                </ul>
                            </nav>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Stock Modal -->
    <div class="modal fade" id="viewStockModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-graph-up"></i> Stock Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewStockContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Progress Modal -->
    <div class="modal fade" id="syncModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Syncing Stocks</h5>
                </div>
                <div class="modal-body text-center" id="syncContent">
                    <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5>Fetching stocks from VNDirect...</h5>
                    <p class="text-muted">This may take a few moments.</p>
                </div>
                <div class="modal-footer" id="syncFooter" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="location.reload()">Refresh Page</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import JSON Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-upload"></i> Import Stocks from JSON</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="importForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Select JSON File</label>
                            <input type="file" class="form-control" id="importFile" name="file" accept=".json" required>
                            <div class="form-text">
                                JSON format: Array of objects with fields: code, type, floor, status, companyName, shortName, etc.
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Tip:</strong> If VNDirect API is blocked, download stock data from another source and import here.
                            <br><br>
                            <strong>Sample format:</strong>
                            <pre class="bg-light p-2 mt-2" style="font-size: 0.75rem;">[
  {
    "code": "VNM",
    "type": "stock",
    "floor": "HOSE",
    "status": "listed",
    "companyName": "Vinamilk",
    "shortName": "VINAMILK"
  }
]</pre>
                        </div>
                    </form>
                    <div id="importResult" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="importStocks()" id="importBtn">
                        <i class="bi bi-upload"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheduler Settings Modal -->
    <div class="modal fade" id="schedulerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-check"></i> Auto Sync Schedule</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="schedulerForm">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="schedulerEnabled" style="width: 3em; height: 1.5em;">
                                <label class="form-check-label ms-2" for="schedulerEnabled">
                                    <strong>Enable Auto Sync</strong>
                                </label>
                            </div>
                            <div class="form-text">Automatically sync stocks from VNDirect daily at the specified time.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule Time (Daily)</label>
                            <input type="time" class="form-control" id="scheduleTime" value="08:00">
                            <div class="form-text">Time to run auto-sync (24-hour format, server timezone)</div>
                        </div>
                        <div class="alert alert-light">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Last Run:</small><br>
                                    <span id="schedulerLastRun">-</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Next Run:</small><br>
                                    <span id="schedulerNextRun">-</span>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div id="schedulerResult" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedulerConfig()" id="saveSchedulerBtn">
                        <i class="bi bi-check"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Config Modal -->
    <div class="modal fade" id="priceConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Price Sync Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="priceConfigForm">
                        <div class="mb-3">
                            <label class="form-label">Delay Between Requests (ms)</label>
                            <input type="number" class="form-control" id="priceDelayMS" value="500" min="100" max="5000">
                            <div class="form-text">Milliseconds to wait between each API request. Higher = slower but safer.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Batch Size</label>
                            <input type="number" class="form-control" id="priceBatchSize" value="50" min="5" max="200">
                            <div class="form-text">Number of stocks to process before taking a longer pause.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Batch Pause (ms)</label>
                            <input type="number" class="form-control" id="priceBatchPauseMS" value="5000" min="1000" max="60000">
                            <div class="form-text">Longer pause after each batch to avoid rate limiting.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price History Size</label>
                            <input type="number" class="form-control" id="pricePriceSize" value="270" min="30" max="1000">
                            <div class="form-text">Number of historical price records to fetch (270 ≈ 1 year).</div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Estimated Time:</strong>
                            <br>With default settings (500ms delay, batch 50, 5s pause):
                            <br>• 1600 stocks ≈ <strong>30-40 minutes</strong>
                            <br>Adjust settings based on API response.
                        </div>
                    </form>
                    <div id="priceConfigResult" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="savePriceConfig()" id="savePriceConfigBtn">
                        <i class="bi bi-check"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Top RS Stocks Modal -->
    <div class="modal fade" id="topRSModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-trophy"></i> Top RS Ranked Stocks</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="topRSContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-info" role="status"></div>
                            <p class="mt-2">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Filter by floor
        function filterByFloor(floor) {
            document.getElementById('floorInput').value = floor;
            document.getElementById('searchForm').submit();
        }

        // View stock details
        function viewStock(code) {
            const modal = new bootstrap.Modal(document.getElementById('viewStockModal'));
            modal.show();

            document.getElementById('viewStockContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading...</p>
                </div>
            `;

            $.get('/admin/api/stocks/' + code, function(stock) {
                let floorBadge = stock.floor === 'HOSE' ? 'badge-hose' :
                                 (stock.floor === 'HNX' ? 'badge-hnx' : 'badge-upcom');

                let html = `
                    <div class="row">
                        <div class="col-12 text-center mb-4">
                            <h1 class="stock-code display-4">${stock.code}</h1>
                            <span class="badge ${floorBadge} fs-6">${stock.floor}</span>
                            ${stock.is_active ? '<span class="badge bg-success fs-6 ms-2">Active</span>' : '<span class="badge bg-secondary fs-6 ms-2">Inactive</span>'}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Company Information</h6>
                            <table class="table table-sm">
                                <tr><th>Company Name</th><td>${stock.company_name || '-'}</td></tr>
                                <tr><th>Company Name (EN)</th><td>${stock.company_name_eng || '-'}</td></tr>
                                <tr><th>Short Name</th><td>${stock.short_name || '-'}</td></tr>
                                <tr><th>Short Name (EN)</th><td>${stock.short_name_eng || '-'}</td></tr>
                                <tr><th>Tax Code</th><td>${stock.tax_code || '-'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Stock Information</h6>
                            <table class="table table-sm">
                                <tr><th>ISIN</th><td><code>${stock.isin || '-'}</code></td></tr>
                                <tr><th>Type</th><td>${stock.type || '-'}</td></tr>
                                <tr><th>Status</th><td>${stock.status || '-'}</td></tr>
                                <tr><th>Listed Date</th><td>${stock.listed_date || '-'}</td></tr>
                                <tr><th>Delisted Date</th><td>${stock.delisted_date || '-'}</td></tr>
                                <tr><th>Last Sync</th><td>${stock.last_sync_at ? new Date(stock.last_sync_at).toLocaleString() : '-'}</td></tr>
                            </table>
                        </div>
                    </div>
                `;
                document.getElementById('viewStockContent').innerHTML = html;
            }).fail(function(xhr) {
                document.getElementById('viewStockContent').innerHTML = `
                    <div class="alert alert-danger">Error loading stock: ${xhr.responseJSON?.error || 'Unknown error'}</div>
                `;
            });
        }

        // Sync stocks from VNDirect
        function syncStocks() {
            if (!confirm('Sync all stocks from VNDirect API? This may take a few moments.')) return;

            const syncModal = new bootstrap.Modal(document.getElementById('syncModal'));
            syncModal.show();

            document.getElementById('syncBtn').disabled = true;

            $.ajax({
                url: '/admin/api/stocks/sync',
                method: 'POST',
                timeout: 300000, // 5 minutes timeout
                success: function(response) {
                    const result = response.result;
                    document.getElementById('syncContent').innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                            <h5 class="mt-3">Sync Completed!</h5>
                            <div class="mt-3">
                                <p class="mb-1"><strong>Total Fetched:</strong> ${result.total_fetched}</p>
                                <p class="mb-1"><strong>Created:</strong> <span class="text-success">${result.created}</span></p>
                                <p class="mb-1"><strong>Updated:</strong> <span class="text-primary">${result.updated}</span></p>
                                ${result.errors && result.errors.length > 0 ?
                                    `<p class="mb-1"><strong>Errors:</strong> <span class="text-danger">${result.errors.length}</span></p>` : ''}
                            </div>
                        </div>
                    `;
                    document.getElementById('syncFooter').style.display = 'flex';
                },
                error: function(xhr) {
                    document.getElementById('syncContent').innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-x-circle text-danger" style="font-size: 4rem;"></i>
                            <h5 class="mt-3">Sync Failed</h5>
                            <p class="text-danger">${xhr.responseJSON?.error || 'Unknown error occurred'}</p>
                        </div>
                    `;
                    document.getElementById('syncFooter').style.display = 'flex';
                    document.getElementById('syncBtn').disabled = false;
                }
            });
        }

        // Delete stock
        function deleteStock(code) {
            if (!confirm('Are you sure you want to delete stock: ' + code + '?')) return;

            $.ajax({
                url: '/admin/api/stocks/' + code,
                method: 'DELETE',
                success: function() {
                    alert('Stock deleted successfully!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        // Auto-complete search (optional enhancement)
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;
            if (query.length >= 2) {
                searchTimeout = setTimeout(function() {
                    // Could implement autocomplete here
                }, 300);
            }
        });

        // Show import modal
        function showImportModal() {
            document.getElementById('importResult').style.display = 'none';
            document.getElementById('importFile').value = '';
            document.getElementById('importBtn').disabled = false;
            const modal = new bootstrap.Modal(document.getElementById('importModal'));
            modal.show();
        }

        // Import stocks from JSON file
        function importStocks() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                alert('Please select a JSON file');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            document.getElementById('importBtn').disabled = true;
            document.getElementById('importBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';

            $.ajax({
                url: '/admin/api/stocks/import',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                timeout: 300000,
                success: function(response) {
                    const result = response.result;
                    document.getElementById('importResult').style.display = 'block';
                    document.getElementById('importResult').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> <strong>Import Successful!</strong>
                            <ul class="mt-2 mb-0">
                                <li>Total: ${result.total_fetched} stocks</li>
                                <li>Created: ${result.created}</li>
                                ${result.errors && result.errors.length > 0 ? `<li class="text-danger">Errors: ${result.errors.length}</li>` : ''}
                            </ul>
                        </div>
                    `;
                    document.getElementById('importBtn').innerHTML = '<i class="bi bi-check"></i> Done';
                    setTimeout(() => location.reload(), 2000);
                },
                error: function(xhr) {
                    document.getElementById('importResult').style.display = 'block';
                    document.getElementById('importResult').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> <strong>Import Failed:</strong>
                            ${xhr.responseJSON?.error || 'Unknown error'}
                        </div>
                    `;
                    document.getElementById('importBtn').disabled = false;
                    document.getElementById('importBtn').innerHTML = '<i class="bi bi-upload"></i> Import';
                }
            });
        }

        // Load scheduler config on page load
        $(document).ready(function() {
            loadSchedulerConfig();
        });

        // Load scheduler configuration
        function loadSchedulerConfig() {
            $.get('/admin/api/stocks/scheduler', function(data) {
                updateSchedulerStatusDisplay(data);
            }).fail(function() {
                document.getElementById('schedulerStatus').textContent = 'Error';
            });
        }

        // Update scheduler status display
        function updateSchedulerStatusDisplay(data) {
            const statusEl = document.getElementById('schedulerStatus');
            if (data.enabled) {
                statusEl.innerHTML = `<span class="badge bg-success">ON</span> ${data.schedule_time}`;
            } else {
                statusEl.innerHTML = '<span class="badge bg-secondary">OFF</span>';
            }
        }

        // Show scheduler modal
        function showSchedulerModal() {
            document.getElementById('schedulerResult').style.display = 'none';

            $.get('/admin/api/stocks/scheduler', function(data) {
                document.getElementById('schedulerEnabled').checked = data.enabled;
                document.getElementById('scheduleTime').value = data.schedule_time || '08:00';

                // Format dates for display
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    const d = new Date(dateStr);
                    return d.toLocaleString();
                };

                document.getElementById('schedulerLastRun').textContent = formatDate(data.last_run);
                document.getElementById('schedulerNextRun').textContent = data.enabled ? formatDate(data.next_run) : '-';

                const modal = new bootstrap.Modal(document.getElementById('schedulerModal'));
                modal.show();
            }).fail(function(xhr) {
                alert('Failed to load scheduler config: ' + (xhr.responseJSON?.error || 'Unknown error'));
            });
        }

        // Save scheduler configuration
        function saveSchedulerConfig() {
            const enabled = document.getElementById('schedulerEnabled').checked;
            const scheduleTime = document.getElementById('scheduleTime').value;

            document.getElementById('saveSchedulerBtn').disabled = true;
            document.getElementById('saveSchedulerBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            $.ajax({
                url: '/admin/api/stocks/scheduler',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    enabled: enabled,
                    schedule_time: scheduleTime
                }),
                success: function(response) {
                    document.getElementById('schedulerResult').style.display = 'block';
                    document.getElementById('schedulerResult').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> Scheduler settings saved!
                            ${response.enabled ? `<br>Next sync: ${new Date(response.next_run).toLocaleString()}` : ''}
                        </div>
                    `;
                    document.getElementById('saveSchedulerBtn').innerHTML = '<i class="bi bi-check"></i> Saved';

                    // Update status display
                    updateSchedulerStatusDisplay(response);

                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('schedulerModal')).hide();
                        document.getElementById('saveSchedulerBtn').disabled = false;
                        document.getElementById('saveSchedulerBtn').innerHTML = '<i class="bi bi-check"></i> Save';
                    }, 1500);
                },
                error: function(xhr) {
                    document.getElementById('schedulerResult').style.display = 'block';
                    document.getElementById('schedulerResult').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> Failed to save: ${xhr.responseJSON?.error || 'Unknown error'}
                        </div>
                    `;
                    document.getElementById('saveSchedulerBtn').disabled = false;
                    document.getElementById('saveSchedulerBtn').innerHTML = '<i class="bi bi-check"></i> Save';
                }
            });
        }

        // ==================== Price Sync Functions ====================

        let priceProgressInterval = null;

        // Load price stats on page load
        $(document).ready(function() {
            loadSchedulerConfig();
            loadPriceStats();
            checkPriceProgress();
        });

        // Load price sync stats
        function loadPriceStats() {
            $.get('/admin/api/prices/stats', function(data) {
                document.getElementById('priceFilesCount').textContent = data.total_files || 0;
                if (data.last_sync) {
                    document.getElementById('priceLastSync').textContent = new Date(data.last_sync).toLocaleString();
                } else {
                    document.getElementById('priceLastSync').textContent = 'Never';
                }
            }).fail(function() {
                document.getElementById('priceFilesCount').textContent = '0';
            });
        }

        // Check if price sync is running
        function checkPriceProgress() {
            $.get('/admin/api/prices/progress', function(data) {
                if (data.status === 'running') {
                    showPriceProgress(true);
                    updatePriceProgress(data);
                    startProgressPolling();
                } else if (data.status === 'completed') {
                    showPriceProgress(false);
                    loadPriceStats();
                }
            });
        }

        // Start price sync
        function startPriceSync() {
            if (!confirm('Start syncing price data for all stocks? This may take 30-40 minutes.')) return;

            document.getElementById('startPriceSyncBtn').disabled = true;

            $.post('/admin/api/prices/sync', function(response) {
                showPriceProgress(true);
                startProgressPolling();
            }).fail(function(xhr) {
                alert('Failed to start sync: ' + (xhr.responseJSON?.error || 'Unknown error'));
                document.getElementById('startPriceSyncBtn').disabled = false;
            });
        }

        // Stop price sync
        function stopPriceSync() {
            if (!confirm('Stop the price sync? Progress will be lost.')) return;

            $.post('/admin/api/prices/stop', function(response) {
                showPriceProgress(false);
                stopProgressPolling();
                loadPriceStats();
            }).fail(function(xhr) {
                alert('Failed to stop sync: ' + (xhr.responseJSON?.error || 'Unknown error'));
            });
        }

        // Show/hide progress bar
        function showPriceProgress(show) {
            document.getElementById('priceSyncProgress').style.display = show ? 'block' : 'none';
            document.getElementById('startPriceSyncBtn').style.display = show ? 'none' : 'inline-block';
            document.getElementById('stopPriceSyncBtn').style.display = show ? 'inline-block' : 'none';
            document.getElementById('startPriceSyncBtn').disabled = false;

            if (show) {
                document.getElementById('priceSyncStatus').innerHTML = '<span class="badge bg-warning">Running</span>';
            } else {
                document.getElementById('priceSyncStatus').innerHTML = '<span class="badge bg-secondary">Idle</span>';
            }
        }

        // Update progress display
        function updatePriceProgress(data) {
            const percent = data.total_stocks > 0 ? Math.round((data.processed_stocks / data.total_stocks) * 100) : 0;

            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressText').textContent = `Processing ${data.processed_stocks} / ${data.total_stocks}`;
            document.getElementById('currentStock').textContent = data.current_stock || '-';
            document.getElementById('successCount').textContent = data.success_count || 0;
            document.getElementById('failedCount').textContent = data.failed_count || 0;
            document.getElementById('etaTime').textContent = data.estimated_time || '-';

            if (data.status === 'completed') {
                showPriceProgress(false);
                stopProgressPolling();
                loadPriceStats();
                document.getElementById('priceSyncStatus').innerHTML = '<span class="badge bg-success">Completed</span>';
            } else if (data.status === 'stopped' || data.status === 'error') {
                showPriceProgress(false);
                stopProgressPolling();
                document.getElementById('priceSyncStatus').innerHTML = `<span class="badge bg-danger">${data.status}</span>`;
            }
        }

        // Start polling for progress
        function startProgressPolling() {
            if (priceProgressInterval) return;

            priceProgressInterval = setInterval(function() {
                $.get('/admin/api/prices/progress', function(data) {
                    updatePriceProgress(data);
                });
            }, 2000); // Poll every 2 seconds
        }

        // Stop polling
        function stopProgressPolling() {
            if (priceProgressInterval) {
                clearInterval(priceProgressInterval);
                priceProgressInterval = null;
            }
        }

        // Show price config modal
        function showPriceConfigModal() {
            document.getElementById('priceConfigResult').style.display = 'none';

            $.get('/admin/api/prices/config', function(data) {
                document.getElementById('priceDelayMS').value = data.delay_ms || 500;
                document.getElementById('priceBatchSize').value = data.batch_size || 50;
                document.getElementById('priceBatchPauseMS').value = data.batch_pause_ms || 5000;
                document.getElementById('pricePriceSize').value = data.price_size || 270;

                const modal = new bootstrap.Modal(document.getElementById('priceConfigModal'));
                modal.show();
            }).fail(function(xhr) {
                alert('Failed to load config: ' + (xhr.responseJSON?.error || 'Unknown error'));
            });
        }

        // Save price config
        function savePriceConfig() {
            const config = {
                delay_ms: parseInt(document.getElementById('priceDelayMS').value),
                batch_size: parseInt(document.getElementById('priceBatchSize').value),
                batch_pause_ms: parseInt(document.getElementById('priceBatchPauseMS').value),
                price_size: parseInt(document.getElementById('pricePriceSize').value)
            };

            document.getElementById('savePriceConfigBtn').disabled = true;
            document.getElementById('savePriceConfigBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

            $.ajax({
                url: '/admin/api/prices/config',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(config),
                success: function(response) {
                    document.getElementById('priceConfigResult').style.display = 'block';
                    document.getElementById('priceConfigResult').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> Settings saved successfully!
                        </div>
                    `;
                    document.getElementById('savePriceConfigBtn').innerHTML = '<i class="bi bi-check"></i> Saved';

                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('priceConfigModal')).hide();
                        document.getElementById('savePriceConfigBtn').disabled = false;
                        document.getElementById('savePriceConfigBtn').innerHTML = '<i class="bi bi-check"></i> Save';
                    }, 1000);
                },
                error: function(xhr) {
                    document.getElementById('priceConfigResult').style.display = 'block';
                    document.getElementById('priceConfigResult').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> Failed: ${xhr.responseJSON?.error || 'Unknown error'}
                        </div>
                    `;
                    document.getElementById('savePriceConfigBtn').disabled = false;
                    document.getElementById('savePriceConfigBtn').innerHTML = '<i class="bi bi-check"></i> Save';
                }
            });
        }

        // ==================== Indicator Functions ====================

        // Load indicator stats on page load
        $(document).ready(function() {
            loadIndicatorStats();
        });

        // Load indicator stats
        function loadIndicatorStats() {
            $.get('/admin/api/indicators/summary', function(data) {
                document.getElementById('indicatorCount').textContent = data.count || 0;
                if (data.updated_at) {
                    document.getElementById('indicatorLastUpdate').textContent = new Date(data.updated_at).toLocaleString();
                }
            }).fail(function() {
                document.getElementById('indicatorCount').textContent = '0';
                document.getElementById('indicatorLastUpdate').textContent = 'Not calculated';
            });
        }

        // Calculate all indicators
        function calculateIndicators() {
            if (!confirm('Calculate technical indicators for all stocks? This may take a few minutes.')) return;

            document.getElementById('calcIndicatorsBtn').disabled = true;
            document.getElementById('indicatorProgress').style.display = 'block';

            $.ajax({
                url: '/admin/api/indicators/calculate',
                method: 'POST',
                timeout: 600000, // 10 minutes
                success: function(response) {
                    document.getElementById('indicatorProgress').style.display = 'none';
                    document.getElementById('calcIndicatorsBtn').disabled = false;
                    alert('Indicators calculated successfully!');
                    loadIndicatorStats();
                },
                error: function(xhr) {
                    document.getElementById('indicatorProgress').style.display = 'none';
                    document.getElementById('calcIndicatorsBtn').disabled = false;
                    alert('Failed: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        // ==================== Filter Widget Functions ====================

        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + ' tỷ';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        function formatBillions(num) {
            // num is already in billions (tỷ VND) from API
            return num.toFixed(2) + ' tỷ';
        }

        function applyFilter() {
            const params = new URLSearchParams();
            params.append('rs_avg_min', document.getElementById('rs_avg_min').value || 0);
            params.append('rs_3d_min', document.getElementById('rs_3d_min').value || 0);
            params.append('rs_1m_min', document.getElementById('rs_1m_min').value || 0);
            params.append('rs_3m_min', document.getElementById('rs_3m_min').value || 0);
            params.append('rs_1y_min', document.getElementById('rs_1y_min').value || 0);
            params.append('macd_hist_min', document.getElementById('macd_hist_min').value || -999);
            params.append('avg_vol_min', document.getElementById('avg_vol_min').value || 0);

            // Price filters (in 1000 VND units)
            const priceMin = parseFloat(document.getElementById('price_min').value) || 0;
            const priceMax = parseFloat(document.getElementById('price_max').value) || 0;
            if (priceMin > 0) params.append('price_min', priceMin);
            if (priceMax > 0) params.append('price_max', priceMax);

            // Avg Trading Val filter (already in tỷ - billions VND)
            const avgTradingValMin = parseFloat(document.getElementById('avg_trading_val_min').value) || 0;
            params.append('avg_trading_val_min', avgTradingValMin);

            params.append('sort_by', document.getElementById('sort_by').value);
            params.append('limit', document.getElementById('limit').value || 50);

            if (document.getElementById('ma10_above_ma30').checked) {
                params.append('ma10_above_ma30', 'true');
            }
            if (document.getElementById('ma50_above_ma200').checked) {
                params.append('ma50_above_ma200', 'true');
            }

            document.getElementById('filter-loading').classList.remove('d-none');
            document.getElementById('filter-result').classList.add('d-none');

            fetch('/admin/api/indicators/top-rs?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    document.getElementById('filter-loading').classList.add('d-none');
                    document.getElementById('filter-result').classList.remove('d-none');
                    document.getElementById('result-count').textContent = data.count;

                    const tbody = document.getElementById('result-table');
                    tbody.innerHTML = '';

                    if (data.stocks && data.stocks.length > 0) {
                        data.stocks.forEach((stock, index) => {
                            const ind = stock.indicators;
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td><strong class="stock-code">${stock.code}</strong></td>
                                <td>${ind.current_price ? ind.current_price.toLocaleString() : '-'}</td>
                                <td><span class="badge bg-primary">${ind.rs_avg || 0}</span></td>
                                <td>${ind.rs_3d_rank || 0}</td>
                                <td>${ind.rs_1m_rank || 0}</td>
                                <td>${ind.rs_3m_rank || 0}</td>
                                <td>${ind.rs_1y_rank || 0}</td>
                                <td class="${ind.macd_hist >= 0 ? 'text-success' : 'text-danger'}">${ind.macd_hist ? ind.macd_hist.toFixed(2) : '-'}</td>
                                <td>${ind.avg_vol ? formatNumber(ind.avg_vol) : '-'}</td>
                                <td>${ind.avg_trading_val ? formatBillions(ind.avg_trading_val) : '-'}</td>
                                <td>${ind.ma10_above_ma30 ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}</td>
                                <td>${ind.ma50_above_ma200 ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted">No stocks match the filter criteria</td></tr>';
                    }
                })
                .catch(error => {
                    document.getElementById('filter-loading').classList.add('d-none');
                    document.getElementById('filter-result').classList.remove('d-none');
                    document.getElementById('result-table').innerHTML = '<tr><td colspan="13" class="text-center text-danger">Error loading data: ' + error.message + '</td></tr>';
                });
        }

        // Show Top RS Stocks modal
        function showTopRSModal() {
            const modal = new bootstrap.Modal(document.getElementById('topRSModal'));
            modal.show();

            document.getElementById('topRSContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-info" role="status"></div>
                    <p class="mt-2">Loading...</p>
                </div>
            `;

            $.get('/admin/api/indicators/top-rs?limit=20', function(data) {
                if (!data.stocks || data.stocks.length === 0) {
                    document.getElementById('topRSContent').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No indicator data available. Please calculate indicators first.
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Code</th>
                                    <th>RS Avg</th>
                                    <th>RS 3D</th>
                                    <th>RS 1M</th>
                                    <th>RS 3M</th>
                                    <th>RS 1Y</th>
                                    <th>RSI</th>
                                    <th>MACD Hist</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.stocks.forEach((stock, idx) => {
                    const ind = stock.indicators;
                    const rsColor = ind.rs_avg >= 80 ? 'success' : (ind.rs_avg >= 50 ? 'primary' : 'secondary');
                    const macdColor = ind.macd_hist > 0 ? 'success' : 'danger';

                    html += `
                        <tr>
                            <td>${idx + 1}</td>
                            <td><strong class="stock-code">${stock.code}</strong></td>
                            <td><span class="badge bg-${rsColor}">${ind.rs_avg.toFixed(0)}</span></td>
                            <td>${ind.rs_3d_rank.toFixed(0)}</td>
                            <td>${ind.rs_1m_rank.toFixed(0)}</td>
                            <td>${ind.rs_3m_rank.toFixed(0)}</td>
                            <td>${ind.rs_1y_rank.toFixed(0)}</td>
                            <td>${ind.rsi.toFixed(1)}</td>
                            <td class="text-${macdColor}">${ind.macd_hist.toFixed(2)}</td>
                            <td>${ind.current_price.toLocaleString()}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="text-muted small mt-2">
                        <i class="bi bi-info-circle"></i> RS Rank: 1-100 (higher = stronger relative strength)
                    </div>
                `;

                document.getElementById('topRSContent').innerHTML = html;
            }).fail(function(xhr) {
                document.getElementById('topRSContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Error: ${xhr.responseJSON?.error || 'Failed to load data'}
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
